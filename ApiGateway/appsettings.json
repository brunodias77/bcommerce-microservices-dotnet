{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Yarp": "Information",
      "System.Net.Http.HttpClient": "Warning"
    }
  },
  "AllowedHosts": "*",
  
  "Keycloak": {
    "Authority": "http://localhost:8080/realms/b-commerce-realm",
    "RequireHttpsMetadata": false,
    "Audience": "b-commerce-backend",
    "ValidIssuers": [
      "http://localhost:8080/realms/b-commerce-realm"
    ]
  },
  
  "Redis": {
    "ConnectionString": "localhost:6379",
    "Database": 0,
    "KeyPrefix": "api-gateway:"
  },
  
  "ServiceDiscovery": {
    "RefreshInterval": "00:01:00",
    "HealthCheckInterval": "00:00:30",
    "Services": {
      "client-service": {
        "BaseUrl": "http://localhost:5122",
        "HealthEndpoint": "/health",
        "Weight": 100
      },
      "catalog-service": {
        "BaseUrl": "http://localhost:5123",
        "HealthEndpoint": "/health",
        "Weight": 100
      },
      "cart-service": {
        "BaseUrl": "http://localhost:5124",
        "HealthEndpoint": "/health",
        "Weight": 100
      },
      "sales-service": {
        "BaseUrl": "http://localhost:5125",
        "HealthEndpoint": "/health",
        "Weight": 100
      }
    }
  },
  
  "RateLimiting": {
    "DefaultPolicy": {
      "RequestsPerMinute": 100,
      "BurstSize": 20
    },
    "AuthenticatedPolicy": {
      "RequestsPerMinute": 200,
      "BurstSize": 50
    },
    "AdminPolicy": {
      "RequestsPerMinute": 1000,
      "BurstSize": 200
    }
  },
  
  "CircuitBreaker": {
    "FailureThreshold": 3,
    "RecoveryTime": "00:00:30",
    "MinimumThroughput": 10
  },
  
  "CORS": {
    "AllowedOrigins": [
      "http://localhost:4200",
      "https://localhost:4200"
    ],
    "AllowedMethods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    "AllowedHeaders": ["*"],
    "AllowCredentials": true
  },
  
  "ReverseProxy": {
    "Routes": {
      "client-service-route": {
        "ClusterId": "client-service-cluster",
        "AuthorizationPolicy": "authenticated",
        "RateLimiterPolicy": "AuthenticatedPolicy",
        "Match": {
          "Path": "/api/client/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/client/{**catch-all}"
          },
          {
            "RequestHeader": "X-Forwarded-For",
            "Append": "{RemoteIpAddress}"
          },
          {
            "RequestHeader": "X-Gateway-Version",
            "Set": "1.0.0"
          },
          {
            "RequestHeader": "X-Request-ID",
            "Set": "{NewGuid}"
          }
        ],
        "Metadata": {
          "Service": "ClientService",
          "Version": "1.0",
          "RequiresAuth": "true"
        }
      },
      "catalog-service-route": {
        "ClusterId": "catalog-service-cluster",
        "RateLimiterPolicy": "DefaultPolicy",
        "Match": {
          "Path": "/api/catalog/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/catalog/{**catch-all}"
          },
          {
            "RequestHeader": "X-Forwarded-For",
            "Append": "{RemoteIpAddress}"
          },
          {
            "RequestHeader": "X-Gateway-Version",
            "Set": "1.0.0"
          },
          {
            "RequestHeader": "X-Request-ID",
            "Set": "{NewGuid}"
          }
        ],
        "Metadata": {
          "Service": "CatalogService",
          "Version": "1.0",
          "RequiresAuth": "false"
        }
      },
      "cart-service-route": {
        "ClusterId": "cart-service-cluster",
        "AuthorizationPolicy": "authenticated",
        "RateLimiterPolicy": "AuthenticatedPolicy",
        "Match": {
          "Path": "/api/cart/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/cart/{**catch-all}"
          },
          {
            "RequestHeader": "X-Forwarded-For",
            "Append": "{RemoteIpAddress}"
          },
          {
            "RequestHeader": "X-Gateway-Version",
            "Set": "1.0.0"
          },
          {
            "RequestHeader": "X-Request-ID",
            "Set": "{NewGuid}"
          },
          {
            "RequestHeader": "X-User-ID",
            "Set": "{ClaimValue:sub}"
          }
        ],
        "Metadata": {
          "Service": "CartService",
          "Version": "1.0",
          "RequiresAuth": "true"
        }
      },
      "sales-service-route": {
        "ClusterId": "sales-service-cluster",
        "AuthorizationPolicy": "authenticated",
        "RateLimiterPolicy": "AuthenticatedPolicy",
        "Match": {
          "Path": "/api/sales/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/sales/{**catch-all}"
          },
          {
            "RequestHeader": "X-Forwarded-For",
            "Append": "{RemoteIpAddress}"
          },
          {
            "RequestHeader": "X-Gateway-Version",
            "Set": "1.0.0"
          },
          {
            "RequestHeader": "X-Request-ID",
            "Set": "{NewGuid}"
          },
          {
            "RequestHeader": "X-User-ID",
            "Set": "{ClaimValue:sub}"
          }
        ],
        "Metadata": {
          "Service": "SalesService",
          "Version": "1.0",
          "RequiresAuth": "true"
        }
      },
      "admin-route": {
        "ClusterId": "client-service-cluster",
        "AuthorizationPolicy": "admin",
        "RateLimiterPolicy": "AdminPolicy",
        "Match": {
          "Path": "/api/admin/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/client/admin/{**catch-all}"
          },
          {
            "RequestHeader": "X-Admin-Request",
            "Set": "true"
          },
          {
            "RequestHeader": "X-User-ID",
            "Set": "{ClaimValue:sub}"
          },
          {
            "RequestHeader": "X-User-Roles",
            "Set": "{ClaimValue:realm_access}"
          }
        ],
        "Metadata": {
          "Service": "AdminService",
          "Version": "1.0",
          "RequiresAuth": "true",
          "RequiresRole": "admin"
        }
      }
    },
    "Clusters": {
      "client-service-cluster": {
        "LoadBalancingPolicy": "RoundRobin",
        "Destinations": {
          "client-service-1": {
            "Address": "http://localhost:5122/",
            "Health": "http://localhost:5122/health",
            "Metadata": {
              "Weight": "100",
              "Region": "local",
              "Version": "1.0.0"
            }
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:01:00",
          "Version": "2.0",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "Metadata": {
          "Service": "ClientService",
          "CircuitBreaker.Enabled": "true",
          "Retry.Enabled": "true"
        }
      },
      "catalog-service-cluster": {
        "LoadBalancingPolicy": "LeastRequests",
        "Destinations": {
          "catalog-service-1": {
            "Address": "http://localhost:5123/",
            "Health": "http://localhost:5123/health",
            "Metadata": {
              "Weight": "100",
              "Region": "local",
              "Version": "1.0.0"
            }
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:00:30",
          "Version": "2.0",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "Metadata": {
          "Service": "CatalogService",
          "CircuitBreaker.Enabled": "true",
          "Retry.Enabled": "true"
        }
      },
      "cart-service-cluster": {
        "LoadBalancingPolicy": "RoundRobin",
        "Destinations": {
          "cart-service-1": {
            "Address": "http://localhost:5124/",
            "Health": "http://localhost:5124/health",
            "Metadata": {
              "Weight": "100",
              "Region": "local",
              "Version": "1.0.0"
            }
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:01:00",
          "Version": "2.0",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "Metadata": {
          "Service": "CartService",
          "CircuitBreaker.Enabled": "true",
          "Retry.Enabled": "true"
        }
      },
      "sales-service-cluster": {
        "LoadBalancingPolicy": "RoundRobin",
        "Destinations": {
          "sales-service-1": {
            "Address": "http://localhost:5125/",
            "Health": "http://localhost:5125/health",
            "Metadata": {
              "Weight": "100",
              "Region": "local",
              "Version": "1.0.0"
            }
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:01:00",
          "Version": "2.0",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "Metadata": {
          "Service": "SalesService",
          "CircuitBreaker.Enabled": "true",
          "Retry.Enabled": "true"
        }
      }
    }
  }
}
